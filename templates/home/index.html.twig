{% extends 'base.html.twig' %}

{% block title %}UTSU{% endblock %}

{% block body %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Utsu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
      border: none;
      cursor: pointer;
      text-decoration: none;
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--primary-foreground);
      padding: 0.5rem 1rem;
    }

    .btn-primary:hover {
      background-color: #334155;
    }

    .btn-ghost {
      background-color: transparent;
      color: var(--foreground);
      padding: 0.5rem 1rem;
    }

    .btn-ghost:hover {
      background-color: var(--accent);
      color: var(--accent-foreground);
    }

    .btn-outline {
      background-color: transparent;
      border: 1px solid var(--border);
      color: var(--foreground);
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
    }

    .btn-outline:hover {
      background-color: var(--accent);
    }

    .btn-sm {
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
    }

    .btn-lg {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
    }

    .card {
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    }

    .card-header {
      padding: 1.5rem 1.5rem 0;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--card-foreground);
    }

    .card-content {
      padding: 1.5rem;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-trigger {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: var(--radius);
    }

    .dropdown-trigger:hover {
      background-color: var(--accent);
    }

    .dropdown-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 0.5rem;
      min-width: 14rem;
      background-color: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 50;
    }

    .dropdown.open .dropdown-menu {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      color: var(--foreground);
      text-decoration: none;
      transition: background-color 0.2s;
    }

    .dropdown-item:hover {
      background-color: var(--accent);
    }

    .dropdown-item.text-red {
      color: #ef4444;
    }

    .dropdown-separator {
      height: 1px;
      background-color: var(--border);
      margin: 0.25rem 0;
    }

    .avatar {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      background-color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar-fallback {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--muted-foreground);
    }

    .main-layout {
      min-height: 100vh;
      background-color: #f9fafb;
      overflow-y: auto;
    }

    .content-wrapper {
      padding: 1.5rem 0;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }

    .main-content {
      /* Styles pour le contenu principal je modifie simplement */
    }

    .posts-header {
      margin-bottom: 1.5rem;
    }

    .posts-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #111827;
      margin-bottom: 0.5rem;
    }

    .posts-filters {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .safe-icon {
        width: 16px;
        height: 16px;
        transition: transform 0.2s ease-in-out;
    }

    .danger-icon {
        width: 16px;
        height: 16px;
        transition: transform 0.1s ease-in-out;
      }

    @keyframes shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(1px, -1px); }
      50% { transform: translate(-1px, 1px); }
      75% { transform: translate(1px, 1px); }
      100% { transform: translate(0, 0); }
    }

    .filter-active {
      background-color: #dbeafe;
      color: #1e40af;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
    }

    .filter-inactive {
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius);
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .filter-inactive:hover {
      background-color: #f3f4f6;
    }

    .posts-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .danger-card {
      background: linear-gradient(to bottom right, #fef2f2, #fee2e2);
      border-color: #fecaca;
    }

    .danger-card .card-title {
      color: #991b1b;
    }

    .danger-card .card-content span {
      color: #b91c1c;
    }

    .danger-card .btn-outline {
      border-color: #fca5a5;
      color: #b91c1c;
    }

    .danger-card .btn-outline:hover {
      background-color: #fef2f2;
    }

    .success-card {
      background: linear-gradient(to bottom right, #f0fdf4, #dcfce7);
      border-color: #bbf7d0;
    }

    .success-card .card-title {
      color: #166534;
    }

    .success-card .card-content span {
      color: #15803d;
    }

    .ranking-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .ranking-number {
      font-size: 0.875rem;
      font-weight: bold;
      color: #15803d;
    }

    .avatar-sm {
      width: 1.5rem;
      height: 1.5rem;
    }

    .avatar-sm .avatar-fallback {
      font-size: 0.625rem;
      background-color: #bbf7d0;
    }

    .points {
      font-size: 0.75rem;
      color: #16a34a;
      margin-left: auto;
    }

    .trend-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .trend-title {
      font-size: 0.875rem;
      font-weight: 500;
    }

    .trend-participants {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .icon {
      width: 1rem;
      height: 1rem;
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .flex {
      display: flex;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-2 {
      gap: 0.5rem;
    }

    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }

    .space-y-3 > * + * {
      margin-top: 0.75rem;
    }

    .space-x-2 > * + * {
      margin-left: 0.5rem;
    }

    .ml-auto {
      margin-left: auto;
    }

    .w-full {
      width: 100%;
    }

    @media (min-width: 768px) {
      .navbar-nav {
        display: flex;
      }

      .content-grid {
        grid-template-columns: 2fr 1fr;
      }

      .container {
        padding: 0 2rem;
      }
    }

    @media (max-width: 767px) {
      .navbar-user .dropdown-trigger span {
        display: none;
      }

      .sidebar {
        order: -1;
      }

      .posts-filters {
        flex-wrap: wrap;
      }
    }

    .safe-icon:hover {
        transform: scale(1.2);
    }

    .danger-icon:hover {
        transform: rotate(15deg);
    }

    .card.clickable-card {
      cursor: pointer;
      transition: box-shadow 0.2s, background 0.2s;
    }
    .card.clickable-card:hover {
      box-shadow: 0 4px 16px 0 rgba(0,0,0,0.12);
      background: #f3f4f6;
    }

    .cat-post {
      color: #B87F59;
      text-decoration: none;
      transition: color 0.2s;
      font-weight: 600;
    }
    .cat-post:hover {
      color: #8c5c36;
      text-decoration: underline;
    }

    .cat-post-popular {
      color: #000000;
      text-decoration: none;
      transition: color 0.2s;
      font-weight: 600;
    }
    .cat-post-popular:hover {
      color: #B87F59;
      text-decoration: underline;
    }
  </style>
</head>
<body class="bg-gray-100">
{% include 'home/_navbar.html.twig' %}

<div class="main-layout">
    <div class="container">
        <div class="content-wrapper">
            <div class="content-grid">
                <!-- Main Content -->
                <div class="main-content">
                    <div class="posts-header">
                        <h1 class="posts-title">Popular posts</h1>
                        <div class="posts-filters">
                            <span class="filter-active">Hot</span>
                            <span class="filter-inactive">New</span>
                            <span class="filter-inactive">Friends</span>
                        </div>
                    </div>

                    <div class="posts-list">
                        {% for post in posts %}
                        <div class="card clickable-card" data-href="{{ path('posts_detail', {'id': post.id}) }}">
                            <div class="card-content">
                                <div class="flex items-center gap-2 text-xs" style="color: #6b7280; margin-bottom: 0.5rem;">
                                    <a class="cat-post text-sm hover:underline" href="{{ path('categories_posts', {'id': post.cat.id}) }}">
                                      c/{{post.cat.name}}
                                    </a>
                                    <span>•</span>
                                    <span>Posted by u/{{ post.userID.username }}</span>
                                    <span>•</span>
                                    <span>{{ post.date|date('d/m/Y') }}</span>
                                </div>
                                <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem; color: #111827;">
                                    {{ post.title }}
                                </h2>
                                <p style="color: #374151; margin-bottom: 1rem;">
                                    {{ post.contenu }}
                                </p>
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center gap-2">
                                        <button class="btn btn-ghost safe-like-btn" style="padding: 0.25rem;" data-post-id="{{ post.id }}">
                                           <svg class="safe-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="16" height="16">
                                              <path d="M12 2L4 5v6c0 5.55 3.84 10.74 8 11 4.16-.26 8-5.45 8-11V5l-8-3z"/>
                                              <path fill="white" d="M10.5 14.5l-2.5-2.5 1.41-1.41L10.5 11.67l4.59-4.59L16.5 8.5z"/>
                                            </svg>
                                        </button>

                                        <span id="safe-likes-{{ post.id }}" class="text-sm" style="font-weight: 600;">{{ post.countSafeLikes() }}</span>

                                        <button class="btn btn-ghost dangerous-like-btn" style="padding: 0.25rem;" data-post-id="{{ post.id }}">
                                            <svg class="danger-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="black" width="16" height="16">
                                                <path d="M1 21h22L12 2 1 21z"/>
                                                <path fill="white" d="M13 16h-2v2h2v-2zm0-6h-2v4h2v-4z"/>
                                            </svg>
                                        </button>
                                        <span id="dangerous-likes-{{ post.id }}" class="text-sm" style="font-weight: 600;">{{ post.countDangerousLikes() }}</span>
                                    </div>
                                    <button class="btn btn-ghost text-sm toggle-comments" data-post-id="{{ post.id }}">
                                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                        </svg>
                                        {{ post.commentaires|length }} Comments
                                    </button>
                                    <button class="btn btn-ghost text-sm">
                                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                        </svg>
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="comments-{{ post.id }}" class="mt-4 hidden bg-white rounded-lg shadow-sm border border-gray-200" data-post-id="{{ post.id }}">
                            <div class="p-4">
                                <!-- Comment Form -->
                                <div id="commentForm-{{ post.id }}" class="mb-6">
                                    <form action="{{ path('home_index') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
                                        <input type="hidden" name="post_id" value="{{ post.id }}">
                                        <input type="hidden" name="comment_parent" value="0">
                                        
                                        <div class="flex items-start space-x-4">
                                            {% if app.user %}
                                                <div class="flex-shrink-0">
                                                    <img src="{{ app.user.ppImg }}" alt="Profile" class="w-8 h-8 rounded-full">
                                                </div>
                                            {% endif %}
                                            <div class="flex-grow">
                                                <div class="mb-4">
                                                    <textarea name="contenu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Write a comment..." required></textarea>
                                                </div>
                                                
                                                <div class="flex items-center space-x-4">
                                                    <div class="flex-grow">
                                                        <div class="flex items-center space-x-2">
                                                            <label class="cursor-pointer text-gray-600 hover:text-gray-800">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                                </svg>
                                                                <input type="file" name="img" class="hidden" accept="image/*">
                                                            </label>
                                                            <label class="cursor-pointer text-gray-600 hover:text-gray-800">
                                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                                </svg>
                                                                <input type="file" name="video" class="hidden" accept="video/*">
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                                        Comment
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>

                                <!-- Comments List -->
                                <div class="space-y-6">
                                    {% if post.commentaires|length == 0 %}
                                        <p class="text-gray-500 text-center py-4">No comments yet. Be the first to comment!</p>
                                    {% else %}
                                        {% for commentaire in post.commentaires %}
                                            {% if commentaire.getComParent() is null %}
                                                <div class="comment-container">
                                                    <div class="flex items-start space-x-4">
                                                        <div class="flex-shrink-0">
                                                            <img src="{{ commentaire.userID.ppImg }}" alt="Profile" class="w-8 h-8 rounded-full">
                                                        </div>
                                                        <div class="flex-grow">
                                                            <div class="bg-gray-50 rounded-lg p-4">
                                                                <div class="flex items-center justify-between mb-2">
                                                                    <div class="flex items-center space-x-2">
                                                                        <span class="font-semibold text-gray-900">{{ commentaire.userID.username }}</span>
                                                                        <span class="text-xs text-gray-500">{{ commentaire.creationDate|date('d/m/Y à H:i') }}</span>
                                                                    </div>
                                                                </div>
                                                                <p class="text-gray-800 whitespace-pre-line">{{ commentaire.contenu }}</p>
                                                                
                                                                {% if commentaire.img %}
                                                                    <div class="mt-3">
                                                                        <img src="{{ asset('uploads/commentaires/photo/' ~ commentaire.img) }}"
                                                                             alt="Comment image"
                                                                             class="max-w-md rounded-lg shadow-sm">
                                                                    </div>
                                                                {% endif %}

                                                                {% if commentaire.video %}
                                                                    <div class="mt-3">
                                                                        <video controls class="max-w-md rounded-lg shadow-sm">
                                                                            <source src="{{ asset('uploads/commentaires/video/' ~ commentaire.video) }}"
                                                                                    type="video/mp4">
                                                                            Your browser does not support the video tag.
                                                                        </video>
                                                                    </div>
                                                                {% endif %}

                                                                <div class="mt-3">
                                                                    <button onclick="showReplyForm({{ post.id }}, {{ commentaire.id }}, '{{ commentaire.userID.username }}')"
                                                                            class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                                                                        ↪ Reply
                                                                    </button>
                                                                </div>
                                                            </div>

                                                            <!-- Replies -->
                                                            {% if commentaire.commentaires|length > 0 %}
                                                                <div class="ml-8 mt-4 space-y-4">
                                                                    {% for reply in commentaire.commentaires %}
                                                                        <div class="flex items-start space-x-4">
                                                                            <div class="flex-shrink-0">
                                                                                <img src="{{ reply.userID.ppImg }}" alt="Profile" class="w-6 h-6 rounded-full">
                                                                            </div>
                                                                            <div class="flex-grow">
                                                                                <div class="bg-gray-50 rounded-lg p-3">
                                                                                    <div class="flex items-center justify-between mb-2">
                                                                                        <div class="flex items-center space-x-2">
                                                                                            <span class="font-semibold text-gray-900">{{ reply.userID.username }}</span>
                                                                                            <span class="text-xs text-gray-500">{{ reply.creationDate|date('d/m/Y à H:i') }}</span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <p class="text-gray-800 whitespace-pre-line">{{ reply.contenu }}</p>
                                                                                    
                                                                                    {% if reply.img %}
                                                                                        <div class="mt-3">
                                                                                            <img src="{{ asset('uploads/commentaires/photo/' ~ reply.img) }}"
                                                                                                 alt="Reply image"
                                                                                                 class="max-w-md rounded-lg shadow-sm">
                                                                                        </div>
                                                                                    {% endif %}

                                                                                    {% if reply.video %}
                                                                                        <div class="mt-3">
                                                                                            <video controls class="max-w-md rounded-lg shadow-sm">
                                                                                                <source src="{{ asset('uploads/commentaires/video/' ~ reply.video) }}"
                                                                                                        type="video/mp4">
                                                                                                Your browser does not support the video tag.
                                                                                            </video>
                                                                                        </div>
                                                                                    {% endif %}

                                                                                    <div class="mt-3">
                                                                                        <button onclick="showReplyForm({{ post.id }}, {{ commentaire.id }}, '{{ reply.userID.username }}')"
                                                                                                class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                                                                                            ↪ Reply
                                                                                        </button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="commentForm" class="hidden mt-4 p-4 bg-white rounded-lg shadow">
                    <form action="{{ path('home_index') }}" method="POST" enctype="multipart/form-data">
                        <input type="hidden" id="comment_post_id" name="post_id" value="">
                        <input type="hidden" id="comment_parent" name="comment_parent" value="0">
                        
                        <div id="replyToBox" class="hidden mb-2 p-2 bg-gray-100 rounded">
                            <span class="text-sm text-gray-600">Replying to <span id="replyToUser" class="font-semibold"></span></span>
                            <button type="button" onclick="cancelReply()" class="ml-2 text-sm text-red-600 hover:text-red-800">Cancel</button>
                        </div>

                        <div class="mb-4">
                            <textarea name="contenu" class="w-full p-2 border rounded" rows="3" placeholder="Write your comment..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image (optional)</label>
                            <input type="file" name="img" accept="image/*" class="w-full">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Video (optional)</label>
                            <input type="file" name="video" accept="video/*" class="w-full">
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Post Comment
                            </button>
                        </div>
                    </form>
                </div>
                <script>
                  document.querySelectorAll('.safe-like-btn, .dangerous-like-btn').forEach(button => {
                  button.addEventListener('click', function () {
                    const postId = this.dataset.postId;
                    const type = this.classList.contains('safe-like-btn') ? 'safe' : 'dangerous';

                    // Ajout d'un log pour vérifier la valeur de `type` envoyée au backend
                    console.log(`Type envoyé: ${type}`);

                    fetch(`/posts/${postId}/toggle-like`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                      },
                      body: JSON.stringify({ type }),
                    })
                    .then(response => {
                      if (!response.ok) {
                        throw new Error('Network response was not ok');
                      }
                      return response.json();
                    })
                    .then(data => {
                      console.log(data); // <=== ajoute ça
                      if (data.message === 'Like toggled successfully') {
                        const safeLikesSpan = document.getElementById(`safe-likes-${postId}`);
                        const dangerousLikesSpan = document.getElementById(`dangerous-likes-${postId}`);
                        if (!dangerousLikesSpan) {
                          console.warn(`Element dangerous-likes-${postId} not found`);
                        } else {
                          dangerousLikesSpan.textContent = data.dangerousLikes;
                        }
                        safeLikesSpan.textContent = data.safeLikes;
                      }
                    })
                    .catch(error => {
                      console.error('There was a problem with the fetch operation:', error);
                    });
                  });
                });       
                </script>
                <script>
                  document.querySelectorAll('.clickable-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                      // Ne pas rediriger si on clique sur un lien ou un bouton à l'intérieur
                      if (e.target.closest('a, button')) return;
                      window.location = this.dataset.href;
                    });
                  });
                </script>
                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Popular Communities -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <a href="{{ path('categories_index') }}" class="hover:text-blue-600 transition-colors">
                                    Popular Communities
                                </a>
                            </h3>
                        </div>
                        {% for category in categories %}
                          <div class="card-content space-y-2">
                              <div class="flex items-center justify-between">
                                  <a class="cat-post-popular text-sm" href="{{ path('categories_posts', {'id': category.id}) }}">
                                    c/{{category.name}}
                                  </a>
                                  <button class="btn btn-outline btn-sm join-btn {% if app.user and category in app.user.abonnements|map(a => a.category) %}bg-blue-100 text-blue-700{% endif %}" data-category-id="{{ category.id }}">
                                    <span class="join-text">{% if app.user and category in app.user.abonnements|map(a => a.category) %}Joined{% else %}Join{% endif %}</span>
                                  </button>
                              </div>
                          </div>
                        {% endfor %}
                    </div>

                    <!-- Most dangerous Community -->
                    <div class="card danger-card">
                        <div class="card-header">
                            <h3 class="card-title flex items-center gap-2">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                Most dangerous Community
                            </h3>
                        </div>
                        <div class="card-content space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm">c/conspiracy</span>
                                <button class="btn btn-outline btn-sm">View</button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">c/controversial</span>
                                <button class="btn btn-outline btn-sm">View</button>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm">c/debate</span>
                                <button class="btn btn-outline btn-sm">View</button>
                            </div>
                        </div>
                    </div>

                    <!-- Trend Debats -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title flex items-center gap-2">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                Trend Debats
                            </h3>
                        </div>
                        <div class="card-content space-y-3">
                            <div class="trend-item">
                                <div class="trend-title">Climate Change Solutions</div>
                                <div class="trend-participants">1.2k participants</div>
                            </div>
                            <div class="trend-item">
                                <div class="trend-title">AI Ethics Discussion</div>
                                <div class="trend-participants">896 participants</div>
                            </div>
                            <div class="trend-item">
                                <div class="trend-title">Education Reform</div>
                                <div class="trend-participants">743 participants</div>
                            </div>
                        </div>
                    </div>

                    <!-- Classement a model citizen -->
                    <div class="card success-card">
                        <div class="card-header">
                          <h3 class="card-title flex items-center gap-2">
                              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-crown">
                                  <path d="M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z"></path>
                                  <path d="M5 21h14"></path>
                              </svg>
                              Classement a model citizen
                          </h3>
                        </div>
                        <div class="card-content space-y-3">
                            {% for user in topUsers %}
                            <div class="ranking-item">
                                <div class="ranking-number">{{ loop.index }}.</div>
                                <div class="avatar avatar-sm">
                                    <div class="avatar-fallback">{{ user.username[:2]|upper }}</div>
                                </div>
                                <span class="text-sm">{{ user.username }}</span>
                                <span class="points">{{ user.dangerous }} pts</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Create Post -->
                    <div class="card">
                        <div class="card-content">
                            <button class="btn btn-primary btn-lg w-full">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Create Post
                            </button>
                        </div>
                    </div>

                    <!-- Home -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Home</h3>
                        </div>
                        <div class="card-content">
                            {% if app.user %}
                                <div class="flex flex-col items-center space-y-4">
                                    <!-- Photo de profil -->
                                    <div class="w-24 h-24 rounded-full overflow-hidden border-2 {% if app.user.dangerous < 30 %}border-red-500{% elseif app.user.dangerous < 70 %}border-yellow-500{% else %}border-green-500{% endif %}">
                                        <img src="{{ app.user.ppImg }}" alt="Profile picture" class="w-full h-full object-cover">
                                    </div>
                                    
                                    <!-- Nom d'utilisateur -->
                                    <div class="text-center">
                                        <h4 class="font-semibold text-lg">{{ app.user.username }}</h4>
                                        <div class="flex items-center justify-center space-x-2 mt-1">
                                            <span class="text-sm {% if app.user.dangerous < 30 %}text-red-500{% elseif app.user.dangerous < 70 %}text-yellow-500{% else %}text-green-500{% endif %}">
                                                {% if app.user.dangerous < 30 %}
                                                    <svg class="w-4 h-4 inline-block" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                                                    </svg>
                                                {% elseif app.user.dangerous < 70 %}
                                                    <svg class="w-4 h-4 inline-block" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-1 8a1 1 0 100-2 1 1 0 000 2z"/>
                                                    </svg>
                                                {% else %}
                                                    <svg class="w-4 h-4 inline-block" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                                                    </svg>
                                                {% endif %}
                                                {{ app.user.dangerous }}% Safe
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Statistiques -->
                                    <div class="grid grid-cols-3 gap-4 w-full text-center">
                                        <div>
                                            <div class="font-semibold">{{ app.user.posts|length }}</div>
                                            <div class="text-xs text-gray-500">Posts</div>
                                        </div>
                                        <div>
                                            <div class="font-semibold">{{ app.user.abonnements|length }}</div>
                                            <div class="text-xs text-gray-500">Following</div>
                                        </div>
                                        <div>
                                            <div class="font-semibold">{{ app.user.abonnements|length }}</div>
                                            <div class="text-xs text-gray-500">Followers</div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-sm text-gray-500">
                                    Your personal UTSU frontpage. Come here to check in with your favorite communities.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.querySelectorAll('.join-btn').forEach(button => {
    button.addEventListener('click', function() {
        const categoryId = this.dataset.categoryId;
        
        fetch(`/categories/${categoryId}/toggle-subscription`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const joinText = this.querySelector('.join-text');
            if (data.isSubscribed) {
                joinText.textContent = 'Joined';
                this.classList.add('bg-blue-100', 'text-blue-700');
                this.classList.remove('btn-outline');
            } else {
                joinText.textContent = 'Join';
                this.classList.remove('bg-blue-100', 'text-blue-700');
                this.classList.add('btn-outline');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>

<script>
function showReplyForm(postId, commentId, username) {
    const form = document.getElementById(`commentForm-${postId}`);
    const parentInput = form.querySelector('input[name="comment_parent"]');
    const replyBox = document.createElement('div');
    replyBox.className = 'mb-2 p-2 bg-gray-100 rounded';
    replyBox.innerHTML = `
        <span class="text-sm text-gray-600">Replying to <span class="font-semibold">${username}</span></span>
        <button type="button" onclick="cancelReply(${postId})" class="ml-2 text-sm text-red-600 hover:text-red-800">Cancel</button>
    `;

    // Supprimer l'ancienne reply box si elle existe
    const oldReplyBox = form.querySelector('.reply-box');
    if (oldReplyBox) {
        oldReplyBox.remove();
    }

    // Ajouter la nouvelle reply box
    replyBox.classList.add('reply-box');
    form.insertBefore(replyBox, form.firstChild);
    
    // Mettre à jour l'ID du commentaire parent
    parentInput.value = commentId;
    
    // Faire défiler jusqu'au formulaire
    form.scrollIntoView({ behavior: 'smooth' });
}

function cancelReply(postId) {
    const form = document.getElementById(`commentForm-${postId}`);
    const parentInput = form.querySelector('input[name="comment_parent"]');
    const replyBox = form.querySelector('.reply-box');
    
    if (replyBox) {
        replyBox.remove();
    }
    
    parentInput.value = 0;
}

document.querySelectorAll('.toggle-comments').forEach(button => {
    button.addEventListener('click', function() {
        const postId = this.dataset.postId;
        const commentsSection = document.getElementById(`comments-${postId}`);
        commentsSection.classList.toggle('hidden');
    });
});
</script>

</body>
</html>

{% endblock %}
